<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII ANSI Table - Streaming Multiline Demo</title>
    <style>
        :root {
            --dracula-bg: #282a36;
            --dracula-current-line: #44475a;
            --dracula-foreground: #f8f8f2;
            --dracula-comment: #6272a4;
            --dracula-cyan: #8be9fd;
            --dracula-green: #50fa7b;
            --dracula-orange: #ffb86c;
            --dracula-pink: #ff79c6;
            --dracula-purple: #bd93f9;
            --dracula-red: #ff5555;
            --dracula-yellow: #f1fa8c;
        }
        
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--dracula-bg);
            background-image: 
                radial-gradient(circle at 30% 30%, rgba(139, 233, 253, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(189, 147, 249, 0.1) 0%, transparent 50%);
            color: var(--dracula-foreground);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(68, 71, 90, 0.6);
            backdrop-filter: blur(12px);
            padding: 35px;
            border-radius: 20px;
            border: 1px solid rgba(139, 233, 253, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 4px 16px rgba(139, 233, 253, 0.1),
                inset 0 1px 0 rgba(248, 248, 242, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
        }
        
        h1 {
            color: var(--dracula-cyan);
            text-align: center;
            text-shadow: 0 2px 8px rgba(139, 233, 253, 0.3), 0 0 20px rgba(139, 233, 253, 0.2);
            border-bottom: 2px solid var(--dracula-cyan);
            padding-bottom: 15px;
            font-size: 2.2em;
            letter-spacing: -0.02em;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        button {
            background: linear-gradient(145deg, var(--dracula-purple), var(--dracula-pink));
            color: var(--dracula-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            margin: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 
                0 4px 16px rgba(189, 147, 249, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 24px rgba(189, 147, 249, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            background: linear-gradient(145deg, var(--dracula-pink), var(--dracula-purple));
        }
        
        button:disabled {
            background: linear-gradient(145deg, var(--dracula-comment), #5a6374);
            color: var(--dracula-selection);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: rgba(98, 114, 164, 0.3);
        }
        
        .demo-output {
            background: rgba(40, 42, 54, 0.9);
            color: var(--dracula-foreground);
            padding: 25px;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre;
            overflow-x: auto;
            min-height: 450px;
            max-height: 650px;
            overflow-y: auto;
            border: 2px solid var(--dracula-cyan);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(139, 233, 253, 0.2),
                inset 0 1px 0 rgba(248, 248, 242, 0.05);
            font-size: 14px;
            line-height: 1.2;
        }
        
        .settings {
            background: linear-gradient(145deg, rgba(68, 71, 90, 0.8), rgba(68, 71, 90, 0.4));
            border: 1px solid rgba(139, 233, 253, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(248, 248, 242, 0.05);
        }
        
        .settings label {
            display: inline-block;
            margin: 5px 15px 5px 0;
            font-weight: bold;
        }
        
        .settings input, .settings select {
            margin: 0 10px;
            padding: 8px 12px;
            border: 1px solid rgba(139, 233, 253, 0.3);
            border-radius: 6px;
            background: rgba(40, 42, 54, 0.8);
            color: var(--dracula-foreground);
            font-family: inherit;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.ready {
            background: linear-gradient(145deg, var(--dracula-green), #45e066);
            color: var(--dracula-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(80, 250, 123, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .status.running {
            background: linear-gradient(145deg, var(--dracula-yellow), #f4e479);
            color: var(--dracula-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(241, 250, 140, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .status.error {
            background: linear-gradient(145deg, var(--dracula-red), #e04545);
            color: var(--dracula-foreground);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(255, 85, 85, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .info-box {
            background: linear-gradient(145deg, rgba(139, 233, 253, 0.15), rgba(139, 233, 253, 0.05));
            border: 1px solid rgba(139, 233, 253, 0.4);
            color: var(--dracula-cyan);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 
                0 4px 16px rgba(139, 233, 253, 0.1),
                inset 0 1px 0 rgba(248, 248, 242, 0.05);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .back-link {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            margin: 10px 0;
            transition: background 0.2s;
        }
        
        .back-link:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div style="text-align: left; margin: 0 0 30px 0;">
        <a href="index.html" class="back-link">&larr; Back to Test Directory</a>
    </div>
    
    <h1>üåä ASCII ANSI Table - Streaming Multiline Demo</h1>
    
    <div class="container">
        <div class="info-box">
            <strong>üéØ About this Demo:</strong> This demo mimics the CLI streaming behavior exactly, where rows are added one by one with proper border handling. 
            It showcases multiline cell support in streaming mode, just like the CLI <code>stream-demo</code> command.
            <br><br>
            <strong>Key Features:</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>Multiline product names (Gaming\nLaptop, Wireless\nMouse, etc.)</li>
                <li>Progressive row addition with proper border replacement</li>
                <li>ANSI color support with HTML conversion</li>
                <li>Same data structure as CLI demo</li>
            </ul>
        </div>
        
        <div class="settings">
            <h3>Demo Settings</h3>
            <label>Rows: <input type="number" id="rows" min="3" max="15" value="5"></label>
            <label>Delay (ms): <input type="number" id="delay" min="200" max="3000" value="800"></label>
            <label>Colors: <input type="checkbox" id="colors" checked></label>
            <label>Border Style: 
                <select id="border">
                    <option value="honeywell">Honeywell (Default)</option>
                    <option value="ramac">RAMAC (ASCII)</option>
                    <option value="norc">NORC</option>
                    <option value="void">Void</option>
                </select>
            </label>
        </div>
        
        <div class="controls">
            <button id="start-demo" onclick="startStreamingDemo()" disabled>üöÄ Start Streaming Demo</button>
            <button id="stop-demo" onclick="stopStreamingDemo()" disabled>üõë Stop Demo</button>
            <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        </div>
        
        <div class="status" id="status">Loading WASM module...</div>
        
        <div class="demo-output" id="output"></div>
        
    </div>

    <script type="module">
        import init, { WasmTable, table, convertAnsiToHtml } from './pkg/ascii_ansi_table.js';
        
        let wasmModule = null;
        let streamingTimeout = null;
        let currentRow = 0;
        let totalRows = 0;
        let tableData = [];
        let streamingActive = false;
        
        async function initializeWasm() {
            try {
                wasmModule = await init();
                document.getElementById('status').textContent = '‚úÖ Ready to start streaming demo';
                document.getElementById('status').className = 'status ready';
                document.getElementById('start-demo').disabled = false;
                return true;
            } catch (error) {
                document.getElementById('status').textContent = '‚ùå Failed to load WASM module: ' + error.message;
                document.getElementById('status').className = 'status error';
                console.error('WASM initialization failed:', error);
                return false;
            }
        }
        
        // Generate the same multiline data as CLI demo
        function generateMultilineStreamingData(rows, useColors) {
            const data = [];
            
            // Header row
            if (useColors) {
                data.push([
                    '\u001b[1;36mID\u001b[0m',
                    '\u001b[1;32mProduct\u001b[0m', 
                    '\u001b[1;33mPrice\u001b[0m',
                    '\u001b[1;35mStatus\u001b[0m'
                ]);
            } else {
                data.push(['ID', 'Product', 'Price', 'Status']);
            }
            
            // Multiline product names (same as CLI)
            const products = [
                "Gaming\nLaptop",
                "Wireless\nMouse", 
                "Mechanical\nKeyboard",
                "4K\nMonitor",
                "Bluetooth\nSpeakers",
                "HD\nWebcam",
                "Noise-Cancelling\nHeadphones",
                "Android\nTablet",
                "Smartphone\nPro",
                "Fast\nCharger",
                "USB-C\nCable", 
                "Power\nAdapter",
                "WiFi\nRouter",
                "Network\nSwitch",
                "Laser\nPrinter"
            ];
            
            const statuses = ["Active", "Sold", "Pending", "Shipped", "Delivered"];
            
            for (let i = 0; i < rows; i++) {
                const product = products[i % products.length];
                const status = statuses[i % statuses.length];
                const price = `$${(i + 1) * 25 + 99}`;
                
                if (useColors) {
                    const statusFormatted = (() => {
                        switch (status) {
                            case "Active": return `\u001b[32m‚úì ${status}\u001b[0m`;
                            case "Sold": return `\u001b[31m‚úó ${status}\u001b[0m`;
                            case "Pending": return `\u001b[33m‚ö† ${status}\u001b[0m`;
                            case "Shipped": return `\u001b[36müöö ${status}\u001b[0m`;
                            case "Delivered": return `\u001b[35müì¶ ${status}\u001b[0m`;
                            default: return status;
                        }
                    })();
                    
                    data.push([
                        `\u001b[37m${i + 1}\u001b[0m`,
                        `\u001b[34m${product}\u001b[0m`,
                        `\u001b[32m${price}\u001b[0m`,
                        statusFormatted
                    ]);
                } else {
                    data.push([
                        `${i + 1}`,
                        product,
                        price,
                        status
                    ]);
                }
            }
            
            return data;
        }
        
        // Simple streaming approach - just render progressively and show the complete table each time
        function renderStreamingTable(data, currentRowCount, borderStyle, useColors) {
            try {
                // Take header + current number of rows
                const partialData = data.slice(0, currentRowCount + 1);
                const wasmTable = new WasmTable();
                wasmTable.setData(partialData);
                
                // Set border configuration if not default
                if (borderStyle !== 'honeywell') {
                    const borderConfig = getBorderConfig(borderStyle);
                    if (borderConfig) {
                        wasmTable.setBorder(borderConfig);
                    }
                }
                
                const output = wasmTable.render();
                // Convert ANSI to HTML for proper display
                return convertAnsiToHtml(output);
            } catch (error) {
                console.error('Error rendering table:', error);
                return `<span style="color: red;">Error rendering table: ${error.message}</span>`;
            }
        }
        
        function getBorderConfig(style) {
            const configs = {
                'honeywell': null, // Default
                'ramac': {
                    topLeft: '+', topRight: '+', topBody: '-', topJoin: '+',
                    bottomLeft: '+', bottomRight: '+', bottomBody: '-', bottomJoin: '+',
                    bodyLeft: '|', bodyRight: '|', bodyJoin: '|',
                    joinLeft: '+', joinRight: '+', joinBody: '-', joinJoin: '+',
                    headerJoin: '+'
                },
                'norc': {
                    topLeft: '‚ïî', topRight: '‚ïó', topBody: '‚ïê', topJoin: '‚ï¶',
                    bottomLeft: '‚ïö', bottomRight: '‚ïù', bottomBody: '‚ïê', bottomJoin: '‚ï©',
                    bodyLeft: '‚ïë', bodyRight: '‚ïë', bodyJoin: '‚ïë',
                    joinLeft: '‚ï†', joinRight: '‚ï£', joinBody: '‚ïê', joinJoin: '‚ï¨',
                    headerJoin: '‚ï¨'
                },
                'void': {
                    topLeft: ' ', topRight: ' ', topBody: ' ', topJoin: ' ',
                    bottomLeft: ' ', bottomRight: ' ', bottomBody: ' ', bottomJoin: ' ',
                    bodyLeft: ' ', bodyRight: ' ', bodyJoin: ' ',
                    joinLeft: ' ', joinRight: ' ', joinBody: ' ', joinJoin: ' ',
                    headerJoin: ' '
                }
            };
            return configs[style] || null;
        }
        
        window.startStreamingDemo = async function() {
            if (!wasmModule) {
                alert('WASM module not initialized');
                return;
            }
            
            if (streamingActive) {
                return;
            }
            
            totalRows = parseInt(document.getElementById('rows').value);
            const delay = parseInt(document.getElementById('delay').value);
            const useColors = document.getElementById('colors').checked;
            const borderStyle = document.getElementById('border').value;
            
            tableData = generateMultilineStreamingData(totalRows, useColors);
            currentRow = 0;
            streamingActive = true;
            
            document.getElementById('start-demo').disabled = true;
            document.getElementById('stop-demo').disabled = false;
            document.getElementById('status').textContent = `üåä Streaming ${totalRows} rows...`;
            document.getElementById('status').className = 'status running';
            
            const output = document.getElementById('output');
            output.textContent = ''; // Clear output
            
            // Initialize streaming demo header
            output.textContent = 'üöÄ ASCII ANSI Table Streaming Demo\\n';
            output.textContent += `üìä Streaming ${totalRows} rows with ${delay}ms delay\\n`;
            output.textContent += `üé® Border style: ${borderStyle}\\n`;
            if (useColors) {
                output.textContent += 'üåà ANSI colors: enabled\\n';
            }
            output.textContent += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n';
            
            // Start with just the header
            const headerHtml = renderStreamingTable(tableData, 0, borderStyle, useColors);
            output.innerHTML = output.textContent.replace(/\\n/g, '<br>') + '<br>' + headerHtml;
            
            // Stream rows one by one
            function streamNextRow() {
                if (!streamingActive || currentRow >= totalRows) {
                    stopStreamingDemo();
                    return;
                }
                
                currentRow++;
                
                try {
                    // Render complete table up to current row (header + currentRow rows)
                    const tableHtml = renderStreamingTable(tableData, currentRow, borderStyle, useColors);
                    
                    // Update display - keep the intro text and show progressive table
                    const introText = 'üöÄ ASCII ANSI Table Streaming Demo<br>' +
                                     `üìä Streaming ${totalRows} rows with ${delay}ms delay<br>` +
                                     `üé® Border style: ${borderStyle}<br>` +
                                     (useColors ? 'üåà ANSI colors: enabled<br>' : '') +
                                     '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br><br>';
                    
                    output.innerHTML = introText + tableHtml;
                    
                    // Update status
                    document.getElementById('status').textContent = 
                        `üåä Streaming... ${currentRow}/${totalRows} rows (${Math.round((currentRow/totalRows)*100)}%)`;
                    
                    output.scrollTop = output.scrollHeight;
                    
                    if (currentRow < totalRows && streamingActive) {
                        streamingTimeout = setTimeout(streamNextRow, delay);
                    } else {
                        stopStreamingDemo();
                    }
                } catch (error) {
                    console.error('Streaming error:', error);
                    output.innerHTML += `<br><span style="color: red;">Error: ${error.message}</span>`;
                    stopStreamingDemo();
                }
            }
            
            // Start streaming after initial header delay
            streamingTimeout = setTimeout(streamNextRow, delay);
        };
        
        window.stopStreamingDemo = function() {
            streamingActive = false;
            
            if (streamingTimeout) {
                clearTimeout(streamingTimeout);
                streamingTimeout = null;
            }
            
            document.getElementById('start-demo').disabled = false;
            document.getElementById('stop-demo').disabled = true;
            
            if (currentRow >= totalRows) {
                document.getElementById('status').textContent = '‚úÖ Streaming demo completed!';
                document.getElementById('status').className = 'status ready';
                
                // Add completion message
                const output = document.getElementById('output');
                output.innerHTML += `<br><br>‚úÖ Streaming demo complete! ${totalRows} rows processed.<br>`;
                output.innerHTML += 'üí° Try different options: more rows, different delays, or border styles!';
            } else {
                document.getElementById('status').textContent = '‚èπÔ∏è Streaming demo stopped';
                document.getElementById('status').className = 'status ready';
            }
        };
        
        window.clearOutput = function() {
            document.getElementById('output').innerHTML = '';
            if (streamingActive) {
                stopStreamingDemo();
            }
            currentRow = 0;
        };
        
        // Initialize WASM module
        initializeWasm();
    </script>
</body>
</html>